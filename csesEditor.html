<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>CSES课程表编辑器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-icons/1.8.1/font/bootstrap-icons.css"
      type="text/css"
      rel="stylesheet"
    />
    <script
      src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/js-yaml/4.1.0/js-yaml.min.js"
      type="application/javascript"
    ></script>
    <script
      src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/Sortable/1.14.0/Sortable.min.js"
      type="application/javascript"
    ></script>
    <!-- <script
      type="module"
      src="https://unpkg.com/@fluentui/web-components"
    ></script> -->
    <script
      type="module"
      src="https://npm.elemecdn.com/@fluentui/web-components"
    ></script>
    <style>
      :root {
        --bg-color: #ffffff;
        --sidebar-bg: #ffffff;
        --border-color: #e3e3e3;
        --text-color: #000000;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: rgb(243, 243, 243);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* 顶部菜单栏 */
      .menu-bar {
        height: 52px;
        background: rgb(243, 243, 243);
        display: flex;
        align-items: center;
        padding: 0 1rem;
      }

      .menu-bar button {
        background: none;
        border: none;
        color: var(--text-color);
        padding: 4px 8px;
        cursor: pointer;
        margin: 0 15px;
      }

      .menu-bar button:hover {
        background: #d3d3d3;
      }

      /* 主容器 */
      .container {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* 左侧功能栏 */
      .activity-bar {
        width: 260px;
        background: rgb(243, 243, 243);
        display: flex;
        flex-direction: column;
        outline: none;
        padding: 5px;
        gap: 2px;
      }

      .activity-item {
        width: 100%;
        cursor: pointer;
        display: flex;
      }

      /* 资源管理器 */
      .explorer {
        width: 250px;
        background: rgb(246, 246, 246);
        border: 1px solid var(--border-color);
        border-right: none;
        overflow-y: auto;
        border-radius: 10px 0 0 0;
        padding: 5px;
        gap: 2px;
      }

      .explorer-item {
        cursor: pointer;
        width: 100%;
      }

      /* 编辑区域 */
      .editor-area {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        background: rgb(249, 249, 249);
        border: 1px solid var(--border-color);
      }

      /* 课程卡片 */
      .class-card {
        /* background: #2d2d2d; */
        padding: 1rem;
        margin-bottom: 8px;
        border-radius: 4px;
        cursor: move;
      }

      .time-input {
        background: #ffffff;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 4px;
        margin: 0 4px;
      }

      /* 拖拽区域 */
      #class-list {
        min-height: 300px;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }

      /* YAML编辑器 */
      #yaml-editor {
        width: 100%;
        height: 500px;
        background: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 1rem;
        font-family: monospace;
      }

      button,
      input,
      select,
      textarea {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
      }

      button:focus,
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #007acc;
        box-shadow: 0 0 0 1px #007acc;
      }

      button {
        cursor: pointer;
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      #subject-form {
        display: flex;
        flex-direction: column;
      }

      #subject-form input {
        width: 100%;
        padding: 0.5rem;
        font-size: 1rem;
        margin: 0.5rem 0;
      }

      #subject-list,
      #schedule-list {
        width: 100%;
      }

      fluent-listbox {
        border: none;
        outline: none;
      }

      .activity-bar {
        border: none;
      }

      fluent-option {
        padding-left: 10px;
      }

      fluent-listbox fluent-option {
        padding-left: 10px;
        background-color: transparent;
      }

      fluent-listbox fluent-option:hover {
        background-color: rgba(223, 223, 223, 0.445);
      }

      fluent-listbox fluent-option.selected {
        background-color: rgb(223, 223, 223);
      }

      fluent-text-field {
        width: 100%;
        margin-bottom: 10px;
      }

      .desktop-only {
        display: block;
      }
      .mobile-only {
        display: none;
      }
      .mobile-only-flex {
        display: none;
      }

      @media (max-width: 768px) {
        .desktop-only {
          display: none;
        }
        .mobile-only {
          display: block;
        }
        .mobile-only-flex {
          display: flex;
        }
        .explorer {
          width: 100vw;
        }
        .activity-bar {
          width: 100vw;
        }
        .editor-area {
          width: 100vw;
        }
      }
    </style>
  </head>
  <body>
    <div class="menu-bar">
      <h2 onclick="about()">CSES Editor&nbsp;</h2>
      <button class="desktop-only" onclick="keyHelp()">快捷键</button>
      <button class="desktop-only" onclick="about()">关于</button>
      <span style="flex: 1"></span>
      <button onclick="clearData()">清空</button>
      <fluent-button style="margin-right: 10px" onclick="importFile()">
        导入文件
      </fluent-button>
      <fluent-button appearance="accent" onclick="exportFile()">
        导出文件
      </fluent-button>
      <input type="file" id="file-input" hidden accept=".yaml,.yml" />
    </div>

    <div class="container">
      <div
        class="mobile-only-flex"
        style="
          position: fixed;
          bottom: 0;
          width: 100%;
          background: rgb(243, 243, 243);
          border-top: 1px solid var(--border-color);
          justify-content: space-around;
          padding: 10px 0;
        "
      >
        <button style="padding: 10px 42px" onclick="toggleExplorer()">
          列表
        </button>
        <button style="padding: 10px 42px" onclick="toggleEditor()">
          编辑
        </button>
      </div>
      <fluent-listbox class="activity-bar">
        <fluent-option
          class="activity-item selected"
          aria-selected="true"
          data-view="schedule"
        >
          <i class="bi bi-calendar"></i>&nbsp;课表编辑
        </fluent-option>
        <fluent-option class="activity-item" data-view="subject">
          <i class="bi bi-journal-bookmark"></i>&nbsp;科目管理
        </fluent-option>
        <fluent-option class="activity-item" data-view="source">
          <i class="bi bi-file-earmark-text"></i>&nbsp;导出预览
        </fluent-option>
      </fluent-listbox>

      <div class="explorer">
        <fluent-listbox
          id="schedule-list"
          style="display: block"
        ></fluent-listbox>
        <fluent-listbox
          id="subject-list"
          style="display: none"
        ></fluent-listbox>
        <fluent-button
          id="add-schedule-btn"
          class="explorer-item"
          onclick="addNewClass()"
          style="display: flex; margin-top: 5px"
        >
          + 添加课程
        </fluent-button>
        <fluent-button
          id="auto-fill-btn"
          class="explorer-item"
          onclick="autoFillClass()"
          style="display: flex; margin-top: 5px"
        >
          <i class="bi bi-lightning-fill"></i>&nbsp;快速填充
        </fluent-button>
        <fluent-button
          id="add-subject-btn"
          class="explorer-item"
          style="display: none; margin-top: 5px"
          onclick="addNewSubject()"
        >
          + 添加科目
        </fluent-button>
      </div>

      <div class="editor-area">
        <div id="schedule-editor" style="display: none">
          <h2>课程计划编辑</h2>
          <br />
          <div
            class="schedule-header"
            style="display: flex; align-items: center"
          >
            课程模式:&nbsp;
            <fluent-combobox id="week-mode" onchange="updateSchedule()">
              <fluent-option value="odd">单周</fluent-option>
              <fluent-option value="even">双周</fluent-option>
              <fluent-option value="all">通用</fluent-option>
            </fluent-combobox>
          </div>
          <br />
          <div
            class="schedule-header"
            style="display: flex; align-items: center"
          >
            启用星期:&nbsp;
            <fluent-combobox id="day-mode" onchange="updateSchedule()">
              <fluent-option value="1">星期一</fluent-option>
              <fluent-option value="2">星期二</fluent-option>
              <fluent-option value="3">星期三</fluent-option>
              <fluent-option value="4">星期四</fluent-option>
              <fluent-option value="5">星期五</fluent-option>
              <fluent-option value="6">星期六</fluent-option>
              <fluent-option value="7">星期日</fluent-option>
            </fluent-combobox>
          </div>
          <br />
          <div id="class-list"></div>
          <fluent-button
            appearance="accent"
            onclick="addNewClassTime()"
            style="margin-top: 1rem"
          >
            + 添加课时
          </fluent-button>
          <fluent-button
            appearance="accent"
            onclick="copySchdule()"
            style="margin-top: 1rem"
          >
            复制副本
          </fluent-button>
        </div>

        <div id="source-editor" style="display: none">
          <h3>YAML预览</h3>
          <textarea id="yaml-editor"></textarea>
        </div>

        <div id="subject-editor" style="display: none">
          <h2>科目信息管理</h2>
          <br />
          <div id="subject-form">
            科目名称:<fluent-text-field
              type="text"
              id="subject-name"
              placeholder="科目名称"
            >
            </fluent-text-field>
            科目简写:<fluent-text-field
              type="text"
              id="subject-simple"
              placeholder="简称"
            >
            </fluent-text-field>
            任课教师:<fluent-text-field
              type="text"
              id="subject-teacher"
              placeholder="任课教师"
            >
            </fluent-text-field>
            教学教室:<fluent-text-field
              type="text"
              id="subject-room"
              placeholder="教室"
            >
            </fluent-text-field>
            <br />
            <fluent-button
              appearance="accent"
              onclick="saveSubject()"
              style="font-size: 1rem"
            >
              保存
            </fluent-button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentData = {
        version: 1,
        subjects: [],
        schedules: [],
      };
      let currentScheduleIndex = -1;

      // 检查设备类型并设置显示状态
      function checkDeviceType() {
        if (window.innerWidth <= 768) {
          document.querySelector(".explorer").style.display = "none";
          document.querySelector(".editor-area").style.display = "none";
        } else {
          document.querySelector(".explorer").style.display = "block";
          document.querySelector(".editor-area").style.display = "block";
        }
      }

      // 监听窗口大小变化
      window.addEventListener("resize", checkDeviceType);

      // 初始检查设备类型
      checkDeviceType();

      function toggleEditor() {
        const editorArea = document.querySelector(".editor-area");
        const explorer = document.querySelector(".explorer");
        const activityBar = document.querySelector(".activity-bar");
        editorArea.style.display = "block";
        explorer.style.display = "none";
        activityBar.style.display = "none";
      }

      function toggleExplorer() {
        const explorer = document.querySelector(".explorer");
        const editorArea = document.querySelector(".editor-area");
        const activityBar = document.querySelector(".activity-bar");
        explorer.style.display = "block";
        editorArea.style.display = "none";
        activityBar.style.display = "block";
      }

      // 初始化
      function init() {
        loadFromStorage();
        initActivityBar();
        initSchedules();
        initSubjects();
        initDragDrop();
      }

      // 从localStorage加载数据
      function loadFromStorage() {
        const saved = localStorage.getItem("csesData");
        if (saved) currentData = JSON.parse(saved);
      }

      // 初始化功能切换栏
      function initActivityBar() {
        document.querySelectorAll(".activity-item").forEach((item) => {
          item.addEventListener("click", () => {
            document
              .querySelectorAll(".activity-item")
              .forEach((i) => i.classList.remove("selected"));
            item.classList.add("selected");
            showView(item.dataset.view);
          });
        });
      }

      // 显示对应视图
      function showView(view) {
        document.querySelectorAll(".editor-area > div").forEach((div) => {
          div.style.display = "none";
        });
        document.getElementsByClassName("explorer")[0].style.display = "block";
        document.getElementById(`${view}-editor`).style.display = "none";
        if (view === "schedule") {
          document.getElementById("schedule-list").style.display = "block";
          document.getElementById("subject-list").style.display = "none";
          document.getElementById("add-subject-btn").style.display = "none";
          document.getElementById("auto-fill-btn").style.display = "flex";
          document.getElementById("add-schedule-btn").style.display = "flex";
          refreshScheduleList();
        } else if (view === "source") {
          document.getElementById("schedule-list").style.display = "none";
          document.getElementById("subject-list").style.display = "none";
          document.getElementsByClassName("explorer")[0].style.display = "none";
          document.getElementById("add-subject-btn").style.display = "none";
          document.getElementById("auto-fill-btn").style.display = "none";
          document.getElementById("add-schedule-btn").style.display = "none";
          document.getElementById(`${view}-editor`).style.display = "block";
          document.getElementById("yaml-editor").value =
            jsyaml.dump(currentData);
        } else if (view === "subject") {
          document.getElementById("schedule-list").style.display = "none";
          document.getElementById("subject-list").style.display = "block";
          document.getElementById("add-subject-btn").style.display = "flex";
          document.getElementById("auto-fill-btn").style.display = "none";
          document.getElementById("add-schedule-btn").style.display = "none";
          refreshSubjectList();
        }
      }

      // 初始化计划列表
      function initSchedules() {
        const container = document.getElementById("schedule-list");
        container.innerHTML = "";
        currentData.schedules.forEach((schedule, index) => {
          const div = document.createElement("fluent-option");
          div.className = "explorer-item";
          const weekMode = schedule.weeks;
          const dayMode = schedule.enable_day;
          div.textContent =
            weekMap[weekMode] && dayMap[dayMode]
              ? weekMap[weekMode] + "_" + dayMap[dayMode]
              : `无规则计划 ${index + 1}`;
          div.addEventListener("click", () => {
            loadSchedule(index);
            document
              .querySelectorAll(".explorer-item")
              .forEach((item) => item.classList.remove("selected"));
            div.classList.add("selected");
          });
          div.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            confirm(
              `确定要删除计划 ${
                weekMap[weekMode] && dayMap[dayMode]
                  ? weekMap[weekMode] + "_" + dayMap[dayMode]
                  : `无规则计划 ${index + 1}`
              } 吗？`,
              (result, index) => {
                if (result) {
                  currentData.schedules.splice(index, 1);
                  saveSchedule();
                  refreshScheduleList();
                }
              },
              index
            );
          });
          container.appendChild(div);
        });
      }

      // 初始化科目列表
      function initSubjects() {
        const container = document.getElementById("subject-list");
        container.innerHTML = "";
        currentData.subjects.forEach((subject, index) => {
          const div = document.createElement("fluent-option");
          div.className = "explorer-item";
          div.textContent = subject.name;
          div.addEventListener("click", () => loadSubject(index));
          container.appendChild(div);
        });
      }
      // 初始化科目列表
      function initSubjects() {
        const container = document.getElementById("subject-list");
        container.innerHTML = "";
        if (currentData.subjects.length === 0) {
          currentData.subjects = [
            { name: "语文", simple: "语", teacher: "老师", room: "" },
            { name: "数学", simple: "数", teacher: "", room: "" },
            { name: "英语", simple: "英", teacher: "", room: "" },
            { name: "物理", simple: "物", teacher: "", room: "" },
            { name: "化学", simple: "化", teacher: "", room: "" },
            { name: "生物", simple: "生", teacher: "", room: "" },
            { name: "历史", simple: "历", teacher: "", room: "" },
            { name: "地理", simple: "地", teacher: "", room: "" },
            { name: "政治", simple: "政", teacher: "", room: "" },
            { name: "信息技术", simple: "信", teacher: "", room: "" },
            { name: "通用技术", simple: "通", teacher: "", room: "" },
            { name: "班会", simple: "班", teacher: "", room: "" },
          ];
          saveSchedule();
        }
        currentData.subjects.forEach((subject, index) => {
          const div = document.createElement("fluent-option");
          div.className = "explorer-item";
          div.textContent = subject.name;
          div.addEventListener("click", () => {
            document
              .querySelectorAll(".explorer-item")
              .forEach((item) => item.classList.remove("selected"));
            div.classList.add("selected");
            loadSubject(index);
          });
          if (index === 0) {
            div.classList.add("selected");
          }
          div.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            confirm(
              `确定要删除科目 ${subject.name} 吗？`,
              (result, index) => {
                if (result) {
                  currentData.subjects.splice(index, 1);
                  saveSchedule();
                  refreshSubjectList();
                }
              },
              index
            );
          });
          container.appendChild(div);
        });
      }

      // 加载某计划
      function loadSchedule(index) {
        currentScheduleIndex = index;
        document.getElementById("schedule-editor").style.display = "block";
        const schedule = currentData.schedules[index];
        const weekMode = schedule.weeks;
        const dayMode = schedule.enable_day;
        const selectedWeekMode = weekMap[weekMode];
        const selectedDayMode = dayMap[dayMode];
        document.getElementById("week-mode").value = selectedWeekMode;
        document.getElementById("day-mode").value = selectedDayMode;
        refreshClassList();
      }

      // 加载某科目
      function loadSubject(index) {
        const subject = currentData.subjects[index];
        document.getElementById("subject-name").value = subject.name;
        document.getElementById("subject-simple").value = subject.simple || "";
        document.getElementById("subject-teacher").value =
          subject.teacher || "";
        document.getElementById("subject-room").value = subject.room || "";
        document.getElementById("subject-editor").style.display = "block";
      }

      // 刷新课程列表
      function refreshClassList() {
        const container = document.getElementById("class-list");
        container.innerHTML = "";

        currentData.schedules[currentScheduleIndex].classes.forEach(
          (cls, index) => {
            const card = document.createElement("fluent-card");
            card.className = "class-card";
            card.innerHTML = `
          <select class="subject-select" onchange="saveClass(${index})">
            ${currentData.subjects
              .map(
                (s) =>
                  `<option value="${s.name}" ${
                    s.name === cls.subject ? "selected" : ""
                  }>${s.name}</option>`
              )
              .join("")}
          </select>
          <input type="time" class="time-input" value="${
            cls.start_time
          }" onchange="saveClass(${index})">
          <input type="time" class="time-input" value="${
            cls.end_time
          }" onchange="saveClass(${index})">
          <fluent-button appearance="accent" onclick="deleteClass(${index})">删除</fluent-button>
        `;
            container.appendChild(card);
          }
        );

        // 初始化拖拽排序
        new Sortable(container, {
          animation: 150,
          onEnd: saveSchedule,
        });
      }

      // 刷新计划列表
      function refreshScheduleList() {
        initSchedules();
      }

      // 刷新科目列表
      function refreshSubjectList() {
        initSubjects();
      }

      // 保存课程安排
      function saveSchedule() {
        // 更新数据逻辑
        localStorage.setItem("csesData", JSON.stringify(currentData));
      }

      // 保存课时
      function saveClass(index) {
        const container = document.getElementById("class-list").children[index];
        const subject = container.querySelector(".subject-select").value;
        const start_time = container.querySelector(".time-input").value;
        const end_time = container.querySelector(".time-input").value;
        currentData.schedules[currentScheduleIndex].classes[index] = {
          subject,
          start_time,
          end_time,
        };
        saveSchedule();
      }

      // 删除课时
      function deleteClass(index) {
        currentData.schedules[currentScheduleIndex].classes.splice(index, 1);
        saveSchedule();
        refreshClassList();
      }

      // 文件导入
      async function importFile() {
        const fileInput = document.getElementById("file-input");
        fileInput.onchange = (e) => {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = jsyaml.load(e.target.result);
              currentData = data;
              saveSchedule();
              location.reload();
            } catch (error) {
              alert(`导入失败: ${error}`);
            }
          };
          reader.readAsText(file);
        };
        fileInput.click();
      }

      // 文件导出
      function exportFile() {
        const yamlStr = jsyaml.dump(currentData);
        const blob = new Blob([yamlStr], { type: "text/yaml" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "schedule.yaml";
        link.click();
      }

      // 清空数据
      function clearData() {
        confirm("确定要清空所有数据吗？", (result) => {
          if (result) {
            localStorage.clear();
            currentData = { version: 1, subjects: [], schedules: [] };
            location.reload();
          }
        });
      }

      // 初始化拖拽导入
      function initDragDrop() {
        document.addEventListener("dragover", (e) => e.preventDefault());
        document.addEventListener("drop", async (e) => {
          e.preventDefault();
          const file = e.dataTransfer.files[0];
          if (file) await importFile(file);
        });
      }

      // 添加新课程
      function addNewClass() {
        const newSchedule = {
          name: "无规则计划",
          classes: [],
        };
        currentData.schedules.push(newSchedule);
        saveSchedule();
        refreshScheduleList();
      }

      // 添加新课时
      function addNewClassTime() {
        currentData.schedules[currentScheduleIndex].classes.push({
          subject: "",
          start_time: "",
          end_time: "",
        });
        saveSchedule();
        refreshClassList();
      }

      // 添加新科目
      function addNewSubject() {
        prompt("请输入科目名称:", (name) => {
          if (name) {
            currentData.subjects.push({ name });
            saveSchedule();
            refreshSubjectList();
          }
        });
      }

      const weekMap = {
        odd: "单周",
        even: "双周",
        all: "通用",
      };

      const dayMap = {
        1: "星期一",
        2: "星期二",
        3: "星期三",
        4: "星期四",
        5: "星期五",
        6: "星期六",
        7: "星期日",
      };

      const dayMap_Full = {
        1: "Monday",
        2: "Tuesday",
        3: "Wednesday",
        4: "Thursday",
        5: "Friday",
        6: "Saturday",
        7: "Sunday",
      };

      // 更新计划名称
      function updateSchedule() {
        const weekMode = document.getElementById("week-mode").value;
        const dayMode = document.getElementById("day-mode").value;
        const selectedWeekMode = Object.keys(weekMap).find(
          (key) => weekMap[key] === weekMode
        );
        const selectedDayMode = Object.keys(dayMap).find(
          (key) => dayMap[key] === dayMode
        );
        const scheduleName = `${
          selectedWeekMode.charAt(0).toUpperCase() + selectedWeekMode.slice(1)
        }_${dayMap_Full[selectedDayMode]}`;
        currentData.schedules[currentScheduleIndex].name = scheduleName;
        currentData.schedules[currentScheduleIndex].enable_day = parseInt(
          selectedDayMode,
          10
        );
        currentData.schedules[currentScheduleIndex].weeks = selectedWeekMode;
        saveSchedule();
        refreshScheduleList();
      }

      // 保存科目
      function saveSubject() {
        const name = document.getElementById("subject-name").value;
        const simple = document.getElementById("subject-simple").value;
        const room = document.getElementById("subject-room").value;
        const teacher = document.getElementById("subject-teacher").value;
        if (name) {
          let subjectIndex = currentData.subjects.findIndex(
            (subject) => subject.name === name
          );
          if (subjectIndex !== -1) {
            currentData.subjects[subjectIndex].simple = simple;
            currentData.subjects[subjectIndex].room = room;
            currentData.subjects[subjectIndex].teacher = teacher;
          } else {
            currentData.subjects.push({ name, simple, room, teacher });
            subjectIndex = currentData.subjects.length - 1;
          }
          saveSchedule();
          refreshSubjectList();
          document.querySelectorAll(".explorer-item").forEach((item, index) => {
            item.classList.toggle("selected", index === subjectIndex);
          });
        } else {
          alert("请填写完整的科目信息");
        }
      }

      function copySchdule() {
        const newSchedule = JSON.parse(
          JSON.stringify(currentData.schedules[currentScheduleIndex])
        );
        newSchedule.name = "无规则计划";
        currentData.schedules.push(newSchedule);
        saveSchedule();
        refreshScheduleList();
      }

      // 处理快捷键
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && (e.key === "ArrowUp" || e.key === "ArrowDown")) {
          e.preventDefault();
          moveExplorerItem(e.key === "ArrowUp" ? -1 : 1);
        } else if (e.altKey && (e.key === "ArrowUp" || e.key === "ArrowDown")) {
          e.preventDefault();
          moveActivityItem(e.key === "ArrowUp" ? -1 : 1);
        }
        // 删除当前选中的项目
        else if (e.key === "Delete") {
          e.preventDefault();
          const activeItem = document.querySelector(".explorer-item.selected");
          if (activeItem) {
            const currentView = document.querySelector(
              ".activity-item.selected"
            ).dataset.view;
            if (currentView === "schedule") {
              const index = Array.from(
                document.querySelectorAll("#schedule-list .explorer-item")
              ).indexOf(activeItem);
              if (index !== -1) {
                currentData.schedules.splice(index, 1);
                saveSchedule();
                refreshScheduleList();
              }
            } else if (currentView === "subject") {
              const index = Array.from(
                document.querySelectorAll("#subject-list .explorer-item")
              ).indexOf(activeItem);
              if (index !== -1) {
                currentData.subjects.splice(index, 1);
                saveSchedule();
                refreshSubjectList();
              }
            }
          }
        }

        // 新增课程或科目
        else if (e.altKey && e.key === "n") {
          e.preventDefault();
          const currentView = document.querySelector(".activity-item.selected")
            .dataset.view;
          if (currentView === "schedule") {
            addNewClass();
          } else if (currentView === "subject") {
            addNewSubject();
          }
        }
      });

      // 在资源管理器中移动项目
      function moveExplorerItem(direction) {
        const activeItem = document.querySelector(".explorer-item.selected");
        if (!activeItem) return;
        const currentView = document.querySelector(".activity-item.selected")
          .dataset.view;
        const items = Array.from(
          document.querySelectorAll(`#${currentView}-list .explorer-item`)
        );
        const currentIndex = items.indexOf(activeItem);
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < items.length) {
          items[currentIndex].classList.remove("selected");
          items[newIndex].classList.add("selected");
          items[newIndex].click();
        }
      }

      // 在活动栏中移动项目
      function moveActivityItem(direction) {
        const activeItem = document.querySelector(".activity-item.selected");
        if (!activeItem) return;
        const items = Array.from(document.querySelectorAll(".activity-item"));
        const currentIndex = items.indexOf(activeItem);
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < items.length) {
          items[currentIndex].classList.remove("selected");
          items[newIndex].classList.add("selected");
          items[newIndex].click();
        }
      }

      function keyHelp() {
        showModal(`<h2>快捷键帮助</h2>
          <b>Ctrl + ↑/↓:</b> 移动偏左栏中的项目
          <b>Alt + ↑/↓:</b> 移动左栏中的项目
          <b>Alt + N:</b> 新增课程或科目
          <b>Delete:</b> 删除当前选中的项目
        `);
      }

      function about() {
        showModal(`<h2>CSES课程表编辑器 v1.1 FluentUI</h2>
        <i>CSES是指The Course Schedule Exchange Schema，
        是一种用于课程表交换的数据格式。
        本工具旨在帮助用户快速编辑CSES格式的课程表。</i>

        <b>当前版本:</b>1.1[250205]
          <b>开发人员:</b>PYLXU、RinLit
          <b>项目地址:</b><a href="https://github.com/CSES-org/CsesWebEditor">GitHub</a>
         <b>开放许可:</b>MIT License`);
      }

      function autoFillClass() {
        showModal(`<h2>快速填充课程表</h2>
        <b>提示:</b> 本功能将会自动填充当前课程表中的所有课程，您可以在下方选择填充的科目。
        <br>
        <fluent-button appearance="accent" onclick="autoFill()">批量添加通用周星期一~星期日</fluent-button>
        `);
      }
      function autoFill() {
        const subjects = currentData.subjects;
        if (subjects.length === 0) {
          alert("请先添加科目");
          return;
        }

        const days = ["1", "2", "3", "4", "5", "6", "7"];
        days.forEach((day) => {
          const newSchedule = {
            name: `All_${dayMap_Full[day]}`,
            classes: [],
            weeks: "all",
            enable_day: parseInt(day, 10),
          };

          currentData.schedules.push(newSchedule);
        });

        saveSchedule();
        refreshScheduleList();
        alert("快速创建周一~周日通用周成功");
      }

      function showModal(content) {
        const modal = document.createElement("fluent-dialog");
        modal.style.setProperty("--dialog-height", "auto");
        modal.setAttribute("trap-focus", "");
        modal.setAttribute("modal", "");
        modal.innerHTML = `
          <div style="margin: 20px;">
        ${content.replace(/\n/g, "<br>")}
        <fluent-button appearance="accent" onclick="this.closest('fluent-dialog').hidden = true" style="margin-top: 1rem;width:100%">关闭</fluent-button>
          </div>
        `;
        document.body.appendChild(modal);
        modal.hidden = false;
      }

      function alert(message) {
        showModal(`<h2>提示</h2><p>${message}</p>`);
      }

      function confirm(message, callback, args) {
        const modal = document.createElement("fluent-dialog");
        modal.style.setProperty("--dialog-height", "auto");
        modal.setAttribute("trap-focus", "");
        modal.setAttribute("modal", "");
        modal.innerHTML = `
          <div style="margin: 20px;">
        <h2>确认</h2>
        <p>${message}</p>
        <fluent-button appearance="accent" onclick="confirmAction(true, this.closest('fluent-dialog'), ${callback}, ${args})" style="margin-top: 1rem;width:49%">确定</fluent-button>
        <fluent-button onclick="confirmAction(false, this.closest('fluent-dialog'), ${callback}, ${args})" style="margin-top: 1rem;width:49%">取消</fluent-button>
          </div>
        `;
        document.body.appendChild(modal);
        modal.hidden = false;
      }

      function confirmAction(result, modal, callback, args) {
        modal.hidden = true;
        document.body.removeChild(modal);
        callback(result, args);
      }

      function prompt(message, callback) {
        const modal = document.createElement("fluent-dialog");
        modal.style.setProperty("--dialog-height", "auto");
        modal.setAttribute("trap-focus", "");
        modal.setAttribute("modal", "");
        modal.innerHTML = `
          <div style="margin: 20px;">
        <h2>${message}</h2>
        <p>在下方编辑框输入文本以继续响应</p><br>
        <fluent-text-field id="prompt-input" style="width: 100%;"></fluent-text-field>
        <fluent-button appearance="accent" onclick="promptAction(true, this.closest('fluent-dialog'), ${callback})" style="margin-top: 1rem;width:49%">确定</fluent-button>
        <fluent-button onclick="promptAction(false, this.closest('fluent-dialog'), ${callback})" style="margin-top: 1rem;width:49%">取消</fluent-button>
          </div>
        `;
        document.body.appendChild(modal);
        modal.hidden = false;
      }

      function promptAction(result, modal, callback) {
        const input = document.getElementById("prompt-input").value;
        modal.hidden = true;
        document.body.removeChild(modal);
        callback(result ? input : null);
      }

      // 启动应用
      init();
    </script>
  </body>
</html>
